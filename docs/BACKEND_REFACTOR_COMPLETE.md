# åç«¯ V3 é‡æ„å®ŒæˆæŠ¥å‘Š

## âœ… å®ŒæˆçŠ¶æ€

**é‡æ„æ—¶é—´**: 2026-02-03  
**å®Œæˆåº¦**: P0 æ ¸å¿ƒä»»åŠ¡ 100% å®Œæˆ

---

## ğŸ“‹ å·²å®Œæˆä»»åŠ¡æ¸…å•

### P0 - æ ¸å¿ƒåŸºç¡€ (å…¨éƒ¨å®Œæˆ)

| # | ä»»åŠ¡ | æ–‡ä»¶ | çŠ¶æ€ |
|---|------|------|------|
| 1 | å®Œå–„ AgentState Schema | `schemas/agent_state.py` | âœ… å·²æ·»åŠ  `ui_feedback` å­—æ®µ |
| 2 | Master Router Node | `graph/nodes/master_router.py` | âœ… å·²å­˜åœ¨ä¸”å®Œå–„ |
| 3 | å®Œå–„ Graph API | `api/graph.py` | âœ… å·²å­˜åœ¨ |
| 4 | åˆ›å»º Action API | `api/action.py` | âœ… æ–°åˆ›å»º |
| 5 | æ³¨å†Œ Action è·¯ç”± | `main.py` + `api/__init__.py` | âœ… å·²æ³¨å†Œ |

### P1 - LangGraph å­å›¾ (å…¨éƒ¨å®Œæˆ)

| # | ä»»åŠ¡ | æ–‡ä»¶ | çŠ¶æ€ |
|---|------|------|------|
| 6 | Module A Subgraph | `graph/subgraphs/module_a.py` | âœ… Writer-Editor-Refiner |
| 7 | Module B Subgraph | `graph/subgraphs/module_b.py` | âœ… Script Adapter |
| 8 | Module C Subgraph | `graph/subgraphs/module_c.py` | âœ… Storyboard Director |
| 9 | ä¸»å›¾ç¼–æ’ | `graph/main_graph.py` | âœ… å·²å­˜åœ¨ä¸”å®Œå–„ |

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. æ–°å¢ Action API

**æ–‡ä»¶**: `backend/api/action.py`

```python
POST /api/action
```

**åŠŸèƒ½**:
- å¤„ç† SDUI æŒ‰é’®ç‚¹å‡»
- ç›´æ¥æ›´æ–° Graph çŠ¶æ€
- æ”¯æŒæ‰€æœ‰ä¸šåŠ¡ Action:
  - `select_plan` - é€‰æ‹©æ•…äº‹æ–¹æ¡ˆ
  - `approve_skeleton` - ç¡®è®¤å¤§çº²
  - `next_episode` - åˆ‡æ¢å‰§é›†
  - `regenerate` - é‡æ–°ç”Ÿæˆ
  - `confirm_script` - ç¡®è®¤å‰§æœ¬
  - `generate_shots` - ç”Ÿæˆåˆ†é•œ
  - ç­‰ç­‰

### 2. å®Œå–„ AgentState

**æ–°å¢å­—æ®µ**:
```python
ui_feedback: str | None  # ç”¨æˆ·å¯è¯»çš„åé¦ˆæ–‡æœ¬
```

### 3. Module å­å›¾

**Module A**: Writer -> Editor -> Refiner é—­ç¯
- è‡ªåŠ¨è´¨é‡æ£€æŸ¥
- æœ€å¤š 3 æ¬¡é‡è¯•
- è¯„åˆ† >= 80 è‡ªåŠ¨é€šè¿‡

**Module B**: å‰§æœ¬æå–
- å°è¯´è½¬å‰§æœ¬
- åœºæ™¯åˆ‡åˆ†

**Module C**: åˆ†é•œç”Ÿæˆ
- å‰§æœ¬è½¬åˆ†é•œ
- é•œå¤´è®¾è®¡

### 4. ä¸»å›¾ç¼–æ’

**å®Œæ•´å·¥ä½œæµ**:
```
START -> Master Router -> Market Analyst -> Story Planner -> Skeleton Builder -
Module A (Novel) -> Module B (Script) -> Module C (Storyboard) -> Save & Exit
```

**ç‰¹æ€§**:
- åŒè·¯ç”±æ¨¡å¼ (æ™ºèƒ½è·¯ç”± + æ¡ä»¶è·¯ç”±)
- Human-in-the-Loop (å…³é”®èŠ‚ç‚¹ç­‰å¾…ç¡®è®¤)
- å­å›¾å°è£… (Module A/B/C)

---

## ğŸ“ æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. `backend/schemas/agent_state.py` - æ·»åŠ  ui_feedback å­—æ®µ
2. `backend/api/__init__.py` - å¯¼å…¥ action_router
3. `backend/main.py` - æ³¨å†Œ action_router

### æ–°å¢çš„æ–‡ä»¶

1. `backend/api/action.py` - SDUI Action å¤„ç† API
2. `backend/graph/subgraphs/module_a.py` - Module A å­å›¾å®šä¹‰
3. `backend/graph/subgraphs/module_b.py` - Module B å­å›¾å®šä¹‰
4. `backend/graph/subgraphs/module_c.py` - Module C å­å›¾å®šä¹‰

### å·²å­˜åœ¨çš„æ–‡ä»¶ (æ— éœ€ä¿®æ”¹)

- `backend/graph/nodes/master_router.py` - Master Router èŠ‚ç‚¹
- `backend/graph/main_graph.py` - ä¸»å›¾ç¼–æ’
- `backend/graph/subgraphs/__init__.py` - å­å›¾å®ç°
- `backend/api/graph.py` - Graph API
- `backend/api/projects.py` - Projects API
- `backend/api/nodes.py` - Nodes API
- `backend/api/jobs.py` - Jobs API

---

## ğŸš€ API ç«¯ç‚¹æ€»è§ˆ

### å·²å®ç°çš„æ ¸å¿ƒ API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|------|
| `/api/health` | GET | å¥åº·æ£€æŸ¥ | âœ… |
| `/api/projects` | GET/POST | é¡¹ç›® CRUD | âœ… |
| `/api/projects/{id}/nodes` | GET/POST | èŠ‚ç‚¹ç®¡ç† | âœ… |
| `/api/nodes/{id}` | GET/PUT/DELETE | èŠ‚ç‚¹è¯¦æƒ… | âœ… |
| `/api/graph/chat` | POST | SSE èŠå¤© | âœ… |
| `/api/graph/approve` | POST | ç”¨æˆ·ç¡®è®¤ | âœ… |
| `/api/graph/state` | GET | è·å–çŠ¶æ€ | âœ… |
| `/api/action` | POST | **SDUI Action** | âœ… **æ–°å¢** |
| `/api/jobs` | GET/POST | ä»»åŠ¡ç®¡ç† | âœ… |
| `/api/models/providers` | GET/POST | æ¨¡å‹ç®¡ç† | âœ… |

---

## ğŸ”„ ä¸‹ä¸€æ­¥

### Step 2: æ–°å‰ç«¯æ ·å¼ä¿®æ”¹

æ ¹æ® `Frontend-Design-V3.md` ä¿®æ”¹æ–°å‰ç«¯ï¼š

1. æ›¿æ¢è‰²å½©ç³»ç»Ÿ (index.css)
2. æ›¿æ¢ç»„ä»¶æ ·å¼ (Button, Card, Dialog)
3. è°ƒæ•´å¸ƒå±€å°ºå¯¸ (Header 56px, Sidebar 240px)

### Step 3: å‰åç«¯å¯¹æ¥

1. åˆ›å»º Card -> Node è½¬æ¢å±‚
2. å¯¹æ¥ API è°ƒç”¨
3. å®ç° SSE æµå¼å“åº”å¤„ç†

### Step 4: é«˜çº§åŠŸèƒ½è¡¥å……

åç«¯æ·»åŠ æ–°å‰ç«¯ç‰¹æœ‰åŠŸèƒ½ï¼š
- `POST /api/images/generate` - å›¾ç‰‡ç”Ÿæˆ
- `POST /api/images/{id}/inpaint` - å±€éƒ¨é‡ç»˜
- `POST /api/images/{id}/outpaint` - æ™ºèƒ½æ‰©å›¾
- `POST /api/videos/generate` - è§†é¢‘ç”Ÿæˆ

---

## ğŸ“Š åç«¯æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /projects  â”‚ â”‚ /nodes     â”‚ â”‚ /graph     â”‚ â”‚ /action   â”‚ â”‚
â”‚  â”‚ /jobs      â”‚ â”‚ /models    â”‚ â”‚ /tools     â”‚ â”‚ /health   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Agent Orchestration                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Master Router                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Market   â”‚ â”‚ Story    â”‚ â”‚ Skeleton â”‚ â”‚ Module A       â”‚ â”‚
â”‚  â”‚ Analyst  â”‚ â”‚ Planner  â”‚ â”‚ Builder  â”‚ â”‚ (Novel Loop)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Module B       â”‚ â”‚ Module C       â”‚ â”‚ Asset Inspector  â”‚ â”‚
â”‚  â”‚ (Script)       â”‚ â”‚ (Storyboard)   â”‚ â”‚ Analysis Lab     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         Data Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ PostgreSQL â”‚ â”‚ Redis      â”‚ â”‚ Supabase   â”‚              â”‚
â”‚  â”‚ story_nodesâ”‚ â”‚ Cache/Queueâ”‚ â”‚ Storage    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… éªŒè¯æ¸…å•

- [x] AgentState åŒ…å«æ‰€æœ‰ V3 å­—æ®µ
- [x] Master Router å®ç°æ„å›¾è¯†åˆ«
- [x] Action API å¤„ç† SDUI æŒ‰é’®
- [x] Module A/B/C å­å›¾å·²åˆ›å»º
- [x] ä¸»å›¾ç¼–æ’å®Œæ•´å·¥ä½œæµ
- [x] æ‰€æœ‰ API è·¯ç”±å·²æ³¨å†Œ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-03  
**é‡æ„å®Œæˆ**: Step 1 âœ…  
**ä¸‹ä¸€æ­¥**: Step 2 - æ–°å‰ç«¯æ ·å¼ä¿®æ”¹
