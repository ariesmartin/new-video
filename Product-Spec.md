# AI 短剧台 - 产品需求文档 V3.0 (融合版)

## 文档信息

| 项目 | 内容 |
|------|------|
| 产品名称 | AI 短剧台 (AI Drama Studio) |
| 版本号 | V3.0 |
| 文档类型 | 产品需求文档 (PRD) |
| 创建日期 | 2026-02-02 |
| 融合来源 | V1 (Product-Spec.md) + V2 (Product-Spec-V2.md) |
| 目标状态 | 可直接开发实施 |

## 版本说明

本文档融合 V1 的详细功能规格和 V2 的现代化产品定位：
- **产品名称**：采用 V2 的 "AI 短剧台"（简洁专业）
- **核心交互**：采用 "对话驱动 + 无限画布" 双核模式（V1+V2 一致）
- **功能模块**：保留 V1 的 3 核心模块，扩展 V2 的生产模块
- **交互协议**：统一使用 SDUI（Server-Driven UI）
- **技术实现**：参考 System-Architecture-V3.md

---

## 1. 产品概述

### 1.1 产品简介

AI 短剧台是一款面向短剧创作者的全流程 AI 辅助创作平台。采用 **模块化架构** 和 **Agentic Workflow**（多智能体协同工作流），覆盖从创意构思到视频合成的完整生产链路。

**核心价值主张**：
> "从想法到荧幕，AI 全程陪伴创作。"

### 1.2 产品定位

本产品是"全流程AI视频自动化系统"的核心基石模块，采用**模块化架构**和**Agentic Workflow**（多智能体协同工作流），实现从用户创意到可执行分镜的端到端自动化生成。

**核心差异化**：
- **漏斗式引导**：不把用户扔给空白对话框，而是通过"一级一级"的参数选择引导用户，降低使用门槛
- **Agentic Workflow**：采用"撰写-审阅(Skill)-精修"的闭环，模拟人类编剧工作室的作业流程
- **模块化架构**：将原本的单一流水线拆分为三个独立模块（小说生成/剧本提取/分镜拆分），支持单独使用或组合使用
- **Server-Driven UI**：AI 返回可交互按钮，降低用户操作门槛
- **结构化输出**：生成的内容必须包含结构化的数据格式，以便后续模块（如视频生成）灵活对接

### 1.3 核心特性

| 特性 | 描述 | 价值 |
|------|------|------|
| **全局 AI 助手** | 在任意模块通过自然语言操作，无需学习复杂界面 | 降低学习成本 |
| **模块化架构** | 8 大独立模块，可单独使用或组合串联 | 灵活适应不同场景 |
| **Agentic Workflow** | 多 Agent 协作，模拟人类创作团队 | 保证输出质量 |
| **SDUI 交互** | AI 返回可交互按钮，降低操作门槛 | 提升用户体验 |
| **智能感知 (Thinking UI)** | 实时显示 AI 思考/搜索/生成状态 | 提升系统透明度 |
| **无缝衔接 (Seamless Flow)** | 首页创意自动携带至工作台，无需重复输入 | 极致冷启动体验 |
| **全流程覆盖** | 小说 → 剧本 → 分镜 → 图片 → 视频 → 配音 → 字幕 → 合成 | 端到端解决方案 |

### 1.4 目标用户

| 用户类型 | 需求场景 | 核心痛点 |
|----------|----------|----------|
| **短剧制作工作室** | 批量生产内容，降低人力成本 | 编剧成本高，产出慢 |
| **个人创作者** | 有创意但缺乏技术，需要 AI 辅助 | 创作门槛高 |
| **内容平台运营方** | 快速验证题材和调性效果 | 试错成本高 |
| **传统编剧** | AI 辅助加速创作，提升效率 | 重复劳动多 |
| **MCN 机构** | 规模化内容生产 | 难以批量生产 |

### 1.5 使用场景

- **快速试水**：验证不同题材和调性的内容效果
- **批量生产**：标准化剧本和分镜的规模化生成
- **灵活组合**：已有小说→直接提取剧本，已有剧本→直接拆分分镜
- **人机协作**：AI生成初稿，人工精修打磨

---

## 2. 核心交互范式

### 2.1 双核交互模式

```
┌─────────────────────────────────────────────────────────────────────┐
│                    对话驱动 + 无限画布 (Chat-Driven Infinite Canvas)   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐ │
│  │                             │    │                             │ │
│  │    AI 控制台 (左/右侧)       │◄──►│      内容白板 (中央)        │ │
│  │                             │    │                             │ │
│  │  • 自然语言对话              │    │   • 节点形式平铺内容         │ │
│  │  • 快捷指令按钮              │    │   • 无限画布自由拖拽         │ │
│  │  • SDUI 交互块               │    │   • 所见即所得              │ │
│  │  • 实时流式响应              │    │   • 多模块内容并存           │ │
│  │                             │    │                             │ │
│  └─────────────────────────────┘    └─────────────────────────────┘ │
│                                                                     │
│  交互流程：                                                          │
│  1. 用户在 AI 控制台输入需求                                         │
│  2. Agent 处理并生成内容                                             │
│  3. 内容以 Node 形式出现在画布上                                     │
│  4. 用户可以拖拽、编辑、连接节点                                     │
│  5. 继续对话迭代优化                                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块导航结构

```
┌─────────────────────────┐
│ 🏠 工作台               │  ← 首页/项目管理
├─────────────────────────┤
│                         │
│ 📝 创作流程             │
│   ├─ 📋 大纲规划         │  ← Level 1-3: 参数锚定/灵感风暴/骨架构建
│   ├─ 📖 小说编写  ✨     │  ← 对话优先的创作工作台 (核心功能)
│   ├─ 🎬 剧本提取         │  ← 小说 → 结构化剧本
│   └─ 🖼️ 分镜拆分         │  ← 剧本 → 可视化分镜
│                         │
│ 🎨 生产模块             │
│   ├─ 🖌️ 分镜生图         │  ← 分镜 → AI 图片
│   ├─ 🎥 图转视频         │  ← 图片 → AI 视频
│   └─ 🎭 资产管理         │  ← 角色/场景/道具库
│                         │
│ 🔨 后期制作             │
│   ├─ 🎤 TTS 配音        │  ← 文本 → 语音
│   ├─ 🎵 BGM 生成        │  ← AI 音乐创作
│   ├─ 📝 字幕生成        │  ← 语音 → 字幕
│   └─ 🎞️ 视频合成        │  ← 最终合成输出
│                         │
├─────────────────────────┤
│ ⚙️ 模型管理             │  ← LLM/图片/视频模型配置
└─────────────────────────┘
```

---

## 3. 功能模块详解

### 3.1 工作台 (Dashboard)

**定位**：快速创建项目 + 项目管理入口

#### 3.1.1 页面布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  [Header: Logo | 项目选择器 | 搜索 | 通知 | 积分 | 用户]            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                    下午好, {username}.                               │
│                 灵感稍纵即逝，抓住它。                               │
│                                                                     │
│    ┌───────────────────────────────────────────────────────────┐    │
│    │                                                           │    │
│    │  描述你的创意...                                          │    │
│    │  (例如: 复仇题材，女主逆袭，10集短剧)                      │    │
│    │                                                           │    │
│    │  ┌──────────────────┐                                     │    │
│    │  │ ⚡ 极速模式 [OFF] │                        [开始生成 →] │    │
│    │  └──────────────────┘                                     │    │
│    └───────────────────────────────────────────────────────────┘    │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────┐     │
│    │  快捷入口                                                 │     │
│    │  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐      │     │
│    │  │ 📖   │  │ 🎬   │  │ 🖼️   │  │ 🎭   │  │ ⚙️   │      │     │
│    │  │小说  │  │剧本  │  │分镜  │  │资产  │  │设置  │      │     │
│    │  └──────┘  └──────┘  └──────┘  └──────┘  └──────┘      │     │
│    └─────────────────────────────────────────────────────────┘     │
│                                                                     │
│    我的项目 ({count})                                  [查看全部 >]  │
│    ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│    │    +     │  │  [封面]  │  │  [封面]  │  │  [封面]  │         │
│    │   新建   │  │ 项目标题 │  │ 项目标题 │  │ 项目标题 │         │
│    │   项目   │  │ 10-26   │  │ 10-31   │  │ 11-02   │         │
│    └──────────┘  └──────────┘  └──────────┘  └──────────┘         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.1.2 功能点

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 时间问候 | 根据当前时间显示"早上好/下午好/晚上好" | P2 |
| 创意输入框 | 500字以内的创意描述，支持 placeholder 示例 | P0 |
| 极速模式 | 开启后自动完成全流程（大纲→小说→剧本→分镜） | P1 |
| 开始生成 | 触发项目创建流程，调用 Master Router | P0 |
| 快捷入口 | 直接跳转到特定模块的图标按钮组 | P1 |
| 项目卡片 | 16:9 封面 + 标题 + 日期，悬停上浮效果 | P0 |
| 新建项目 | 创建空白项目的入口 | P0 |

#### 3.1.3 用户入口流程

##### 入口A: 首页AI对话输入（极速模式）

```
用户输入创意描述
        │
        ▼
[开始生成] 按钮点击
        │
        ▼
┌─────────────────────────────────────┐
│ 浏览器行为 (Frontend):              │
│ 1. sessionStorage.setItem('prompt') │
│ 2. chatService.clearSession()       │
│ 3. 创建临时项目 (TempProject)       │
│ 4. Navigate to Script Workshop      │
└─────────────────────────────────────┘
        │
        ▼
到达剧本工坊 (Script Workshop)
        │
        ▼
┌─────────────────────────────────────┐
│ 自动初始化 (AIAssistantBar):        │
│ 1. 读取 sessionStorage 'prompt'     │
│ 2. 自动发送 prompt 给 AI            │
│ 3. 显示 Market Analyst "思考中..."   │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│ AI Agent处理 (Master Router)        │
│ 1. Market Analyst → 分析题材/调性    │
│    (显示: "🔍 正在分析市场趋势...")   │
│ 2. Story Planner → 生成故事方案      │
│    (显示: "✍️ 正在构思故事方案...")   │
└─────────────────────────────────────┘
        │
        ▼
AI 返回推荐方案和交互按钮 (SDUI)
        │
        ▼
用户交互并确认方案... (后续流程同上)
```

##### 入口B: 首页"剧本工坊"按钮

```
用户点击"剧本工坊"按钮
        │
        ▼
判断: 是否有 currentProject + currentEpisode?
        │
        ├─ 有 → 直接跳转对应剧本工坊
        │
        └─ 无
            │
            ▼
    弹出选择对话框: "您想如何开始创作？"
        │
        ├─ [从AI对话开始] → 走入口A流程（AI生成内容）
        │
        └─ [直接编写剧本] → 
            │
            ▼
        创建空白项目+剧集
            │
            ▼
        进入剧本工坊（空白编辑器）
            │
            ▼
        用户通过AI助手侧边栏与AI对话生成内容
            │
            ▼
        保存剧本后自动转正项目（更新名称）
```

##### 入口C: 画板页面"剧本"按钮

```
用户点击画板页面的"剧本"按钮
        │
        ▼
判断: 当前项目是否有 scriptText?
        │
        ├─ 有内容 → 直接跳转剧本工坊
        │
        └─ 无内容
            │
            ▼
        弹出选项对话框（同入口B）
            │
            ├─ [AI协助创作] → 跳转剧本工坊 + 打开AI助手面板
            │
            └─ [手动编写] → 跳转剧本工坊（空白编辑器）
```

**关键设计原则**: 
- 不强制用户先创建项目，降低使用门槛
- 提供多种入口方式，适应不同使用习惯
- AI生成内容后才确认项目名称，避免空项目

---

### 3.2 大纲规划 (Level 1-3)

#### 3.2.1 Level 1: 参数锚定

**功能描述**：通过 AI 聊天窗口，引导用户确定项目的题材、基调和核心参数。

**交互方式**：
1. **AI 提问**：系统启动后，Market Analyst Agent 主动提问
   - "您想做一个什么类型的短剧？"
   - "最近复仇题材很火，要不要试试？"
   
2. **参数选择**：
   - **一级分类（题材赛道）**：
     - 现代言情
     - 奇幻仙侠
     - 逆袭复仇
     - 悬疑脑洞
     - 现实主义
   
   - **二级分类（细分标签）**：
     - 现代言情：霸总、萌宝、先婚后爱、银发黄昏恋、职场恋情
     - 奇幻仙侠：宫廷权谋、仙侠情缘、穿越系统、女尊女强、国潮文旅
     - 逆袭复仇：战神回归、豪门赘婿、重生改命、真假千金、手撕渣男
     - 悬疑脑洞：规则怪谈、无限流、末世求生、AI互动游戏、赛博朋克
     - 现实主义：婆媳关系、乡村致富、非遗传承、反诈普法
   
   - **三级参数（基础配置）**：
     - 体量：单集字数（300字 / 500字 / 800字）
     - 结局：HE / BE / OE
     - 目标集数：10 / 20 / 30 / 80 / 100

3. **AI 增强**：
   - 实时推荐"最可能成功的组合"（基于市场数据）
   - 检测冲突组合（如"男频+甜宠"）并友好提示

#### 3.2.2 Level 2: 灵感风暴

**功能描述**：基于阶段一收集的参数，Planner Agent 生成3-5个具体的"故事核"方案供用户选择或修改。

**方案展示**（卡片网格）：

```
┌─────────────────────────────────────────────────────────────────────┐
│  AI 为您生成了 3 个故事方案                                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ 《方案A》    │  │ 《方案B》    │  │ 《方案C》    │              │
│  │              │  │              │  │              │              │
│  │ Logline:     │  │ Logline:     │  │ Logline:     │              │
│  │ 一句话梗概   │  │ 一句话梗概   │  │ 一句话梗概   │              │
│  │              │  │              │  │              │              │
│  │ 男主: ...    │  │ 男主: ...    │  │ 男主: ...    │              │
│  │ 女主: ...    │  │ 女主: ...    │  │ 女主: ...    │              │
│  │              │  │              │  │              │              │
│  │ 爽点: ...    │  │ 爽点: ...    │  │ 爽点: ...    │              │
│  │              │  │              │  │              │              │
│  │ [选择此方案] │  │ [选择此方案] │  │ [选择此方案] │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
│  [✨ 融合方案]  [✍️ 自定义修改]                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**AI 增强**：
- **反套路雷达 (Anti-Cliché Radar)**：
  - 自检生成的梗概是否属于 Top 10 常见俗套
  - 若命中俗套，强制触发 **Twist (反转) 机制**

- **方案融合 (Fusion Mixer)**：
  - 用户可勾选多个方案（如A的人设 + B的剧情梗概）
  - 点击"融合生成"，AI自动缝合出新方案

#### 3.2.3 Level 3: 骨架构建

**功能描述**：生成详细人设（Character Bible）和分集大纲（Beat Sheet），用户确认后锁定为"只读"真理。

**人设生成**：
- 外貌描述（为画图准备）
- 性格缺陷
- 核心欲望
- 说话方式
- **配角高光**：给核心配角分配一条独立的 "B故事 (B-Story)" 暗线

**分集大纲生成**：
- 黄金前三集：必须包含强冲突和悬念
- 整体节奏：每10集一个小高潮

**用户确认**：
- 可以修改人设或大纲
- 确认后，大纲被锁定为"只读"真理

---

### 3.3 小说编写工坊 (Novel Workshop)

**定位**：以对话为核心的专业创作工作台

#### 3.3.1 页面布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  [Header]  AI 短剧台 > 小说编写                                     │
├─────┬───────────────────────────────────────────────────────┬───────┤
│     │                                                       │       │
│ 章  │                                                       │ AI    │
│ 节  │              小说内容区域                              │ 创作  │
│ 列  │            (Markdown 编辑器)                          │ 助手  │
│ 表  │                                                       │       │
│     │  剧本：《野犬加冕》                                    │ (400  │
│ [+] │                                                       │  px)  │
│ 新增│  【场次】：EXT. 矿井入口 - 黄昏                        │       │
│     │  【人物】：林恩（20岁，脸色苍白...）                   │ [对话 │
│ • 第│                                                       │ 历史] │
│  1集│  【正文】：                                           │       │
│ • 第│  巨大的液压门在他身后发出沉闷的轰鸣...                │ [AI   │
│  2集│                                                       │ 回复] │
│ • 第│                                                       │       │
│  3集│                                                       │ [按钮 │
│     │  ───────────────────────────────────────────          │  组]  │
│     │  [保存] [导出]  [版本历史]        字数: 1,085        │       │
│     │                                                       │快捷:  │
│(200 │                                                       │[续写] │
│ px) │                                                       │[扩写] │
│     │                                                       │[润色] │
└─────┴───────────────────────────────────────────────────────┴───────┘
```

#### 3.3.2 功能点

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 章节管理 | 左侧章节列表，支持增删改查、拖拽排序 | P0 |
| 富文本编辑 | Markdown 实时预览，支持标准剧本格式 | P0 |
| AI 续写 | 基于上下文自动生成下一段内容 | P0 |
| AI 扩写 | 选中片段，扩展为更丰富的描写 | P1 |
| AI 润色 | 优化语言表达，增强文学性 | P1 |
| 风格克隆 | 上传样章，AI 提取文风 DNA 并应用 | P1 |
| 情绪曲线 | 可视化展示章节情绪变化 | P2 |
| 角色弧光 | 追踪角色成长轨迹 | P2 |
| 版本历史 | 支持多版本对比和回滚 | P1 |
| 字数统计 | 实时显示当前章节字数 | P0 |
| 右键菜单 | 选中文字后右键调用 AI | P1 |
| **自动保存** | **每30秒自动保存剧本，失焦时立即保存，显示保存状态** | **P0** |
| **分镜生成** | **剧本完成后一键AI生成分镜预览，确认后同步到画板** | **P1** |

#### 3.3.3 快捷操作按钮

| 按钮 | 功能 | 快捷键 | 触发 Action |
|------|------|--------|-------------|
| 续写下文 | 基于上下文生成后续内容 | Ctrl+Enter | `continue_writing` |
| 扩写片段 | 选中片段扩展为更丰富描写 | Ctrl+E | `expand_selection` |
| 改写风格 | 调整文风（更通俗/更文艺） | - | `change_style` |
| 润色优化 | 优化语言表达 | Ctrl+L | `polish_text` |
| 情绪曲线 | 可视化情绪变化 | - | `show_emotion_curve` |
| 角色弧光 | 追踪角色成长轨迹 | - | `show_character_arc` |

#### 3.3.4 文风克隆

```
用户上传样章 (500字)
        │
        ▼
AI 分析并提取 "文风DNA"
├─ 句长特征: 短句为主 / 长句为主 / 长短结合
├─ 修辞习惯: 暗喻 / 排比 / 对偶 / 拟人
├─ 用词风格: 现代 / 古风 / 口语化 / 书面化
├─ 叙事节奏: 快节奏 / 慢节奏
└─ 情感密度: 高 / 中 / 低
        │
        ▼
应用文风DNA到后续生成
```

#### 3.3.5 自动保存机制

**功能描述**：剧本编辑器自动保存用户输入，避免数据丢失。

**保存策略**：
| 触发条件 | 行为 | 显示状态 |
|---------|------|---------|
| 每30秒 | 自动检查并保存变更内容 | ● 未保存 → ⏳ 保存中... → ✓ 已保存 |
| 失焦时 | 立即保存当前内容 | 实时更新保存状态指示器 |
| 手动保存 | Ctrl+S 或点击保存按钮 | Toast提示"剧本已保存" |

**保存状态显示**：
- 编辑器右上角显示实时保存状态
- **✓ 已保存** (绿色) - 内容已同步到服务器
- **⏳ 保存中...** (黄色) - 正在进行保存操作
- **● 未保存** (橙色) - 有变更待保存

**技术实现**：
- 前端使用 `useEffect` 定时器每30秒检查变更
- 使用 `onBlur` 事件监听编辑器失焦
- 对比 `lastSavedText` 和当前内容，避免重复保存
- 后端 `episodesService.updateEpisode()` 接口保存剧本

---

#### 3.3.6 分镜生成流程

**功能描述**：剧本编写完成后，AI自动解析剧本内容生成分镜预览，用户确认后批量创建分镜节点。

**生成流程**：

```
用户在剧本工坊完成剧本编辑
        │
        ▼
切换Tab: 点击"分镜"Tab
        │
        ▼
┌─────────────────────────────────────┐
│ 显示分镜生成器组件                   │
│ • 提示"AI将自动解析剧本生成分镜"     │
└─────────────────────────────────────┘
        │
        ▼
点击"一键生成分镜"按钮
        │
        ▼
┌─────────────────────────────────────┐
│ AI解析剧本 (ScriptParser Agent)      │
│ 1. 识别场景分割 (【场次】, EXT/INT)  │
│ 2. 提取景别信息 (全景/中景/特写)     │
│ 3. 分析运镜方式 (推/拉/摇/移)       │
│ 4. 提取对白和动作描述                │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│ 显示分镜预览网格                     │
│ • 镜头编号、景别标签、运镜方式        │
│ • 画面描述、对白内容                  │
│ • 占位图 (等待后续生图)              │
└─────────────────────────────────────┘
        │
        ▼
用户操作选择:
├─ [确认并同步到画板] → 批量创建分镜 → 跳转画板页面
├─ [重新生成] → 再次AI解析
└─ [手动调整] → 编辑单个分镜参数
```

**分镜卡片信息**：
| 字段 | 说明 | 示例 |
|------|------|------|
| 镜头编号 | 自动生成顺序号 | #1, #2, #3... |
| 景别 | AI识别的镜头类型 | 全景/中景/特写 |
| 运镜 | 运镜方式 | 推近/拉远/平移 |
| 画面描述 | AI生成的视觉描述 | "矿井入口，黄昏，液压门" |
| 对白 | 剧本中的对白内容 | "林恩: 我必须进去" |

**技术实现**：
- 前端 `StoryboardGenerator` 组件管理生成流程
- 调用 `shotsService.batchCreateShots()` 批量保存分镜
- 后端支持批量创建分镜节点并初始化位置

---

#### 3.3.7 思维链机制 (Chain-of-Thought)

**功能描述**：Writer Agent 在写作前必须先输出 `<thinking>` 块，推演本集的因果逻辑和情绪曲线，杜绝逻辑崩坏。

**工作原理**：
```
用户: "续写第5集"
        │
        ▼
Writer Agent
├─ 输出 <thinking> 块
│   ├─ 核心冲突分析
│   ├─ 角色动机推演
│   ├─ 情节发展路径
│   ├─ 情绪曲线设计
│   └─ 悬念设置
│
├─ 基于思考生成正文
└─ 返回完整内容 (含思考过程)
        │
        ▼
前端: 折叠显示 <thinking>，默认展示正文
      点击可展开查看 AI 思考过程
```

**界面展示**：
```
┌────────────────────────────────────────────┐
│ 🤖 AI 正在思考...                           │
├────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐ │
│ │ <thinking>                             │ │
│ │ 1. 核心冲突: 男主面临背叛抉择          │ │
│ │ 2. 动机: 保护妹妹 vs 忠诚于组织        │ │
│ │ 3. 情绪曲线: 平静→紧张→爆发→余韵      │ │
│ │ 4. 悬念: 结尾揭示内鬼身份              │ │
│ │ </thinking>                            │ │
│ └────────────────────────────────────────┘ │
│ [显示思考过程 ▼]                           │
├────────────────────────────────────────────┤
│ 正文:                                       │
│ 林恩的手指悬在扳机上，冷汗顺着额角滑落...  │
└────────────────────────────────────────────┘
```

---

### 3.4 剧本提取引擎 (Script Extractor)

**定位**：将小说转化为标准结构化剧本

#### 3.4.1 页面布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  [Header]  AI 短剧台 > 剧本提取                                     │
├─────┬─────────────────────┬─────────────────────────┬───────────────┤
│     │                     │                         │               │
│ 章  │   小说原文          │      提取后剧本         │  AI 助手      │
│ 节  │   (左侧显示)        │      (右侧显示)         │  (折叠)       │
│ 列  │                     │                         │               │
│ 表  │ 原文内容...         │ S01 - 矿井入口 - 黄昏   │  [展开 <]     │
│     │                     │                         │               │
│     │                     │ 林恩: (画外) 来...      │               │
│     │                     │                         │               │
│     │                     │ △ 风啸声，夹杂着...    │               │
│     │                     │                         │               │
│(200 │                     │                         │               │
│ px) │                     │ [叙事方式切换 ▼]        │               │
│     │                     │ [重新提取] [导出]       │               │
└─────┴─────────────────────┴─────────────────────────┴───────────────┘
```

#### 3.4.2 功能点

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 叙事方式 | 对话驱动(80%对白) / 旁白驱动(60%旁白) / 混合平衡 | P0 |
| 智能切分 | 自动识别场景边界，每场 <200 字 | P0 |
| 对话口语化 | 去书面化，加入口语噪音和真实感 | P0 |
| 资产绑定 | 每场戏 Header 声明 Active Assets | P1 |
| 格式导出 | Fountain / JSON / PDF | P1 |
| 左右对比 | 原文和剧本并排显示 | P1 |

**剧本元素标记**：
- **D (Dialogue)**：对话
- **A (Action)**：动作
- **V (Voiceover)**：旁白
- **S (Sound)**：音效

---

### 3.5 分镜拆分引擎 (Storyboard Generator) - v6.0 节点形式

**定位**：将剧本转化为可视化分镜节点，支持每集独立画布

#### 3.5.1 页面布局 (v6.0 动态面板)

```
┌─────────────────────────────────────────────────────────────────────┐
│  [Header]  AI 短剧台 > 第一集:深井的回响                            │
├─────────────────────────────────────────────────────────────────────┤
│ ← │                                                                 │
│[📁│                           中央无限画布                          │
│[📄│                                                                 │
│[📊│              ┌───┐      ┌───┐      ┌───┐                       │
│[😊│              │01 │─────→│02 │─────→│03 │   极简节点 (120×80)   │
│[🖼️│              │[图│      │[图│      │[图│                       │
│ > │              └───┘      └───┘      └───┘                       │
│   │                                                                 │
│   │  ┌─────────────────────────────────┐                           │
│   │  │ SCENE 01 Master                 │   25格概览节点            │
│   │  │ ┌─┬─┬─┬─┬─┐                     │   (280×320)               │
│   │  │ │1│2│3│4│5│                     │                           │
│   │  │ ├─┼─┼─┼─┼─┤                     │                           │
│   │  │ │6│7│8│9│10│                    │                           │
│   │  │ └─┴─┴─┴─┴─┘                     │                           │
│   │  └─────────────────────────────────┘                           │
│   │                                                                 │
│   │  ← 左边缘窄条 (48px)                                             │
└─────────────────────────────────────────────────────────────────────┘
        ↓ 点击左侧剧集展开
┌─────────────────────────────────────────────────────────────────────┐
│ 📁 第一集 > 分镜                                                    │
│                                                                     │
│ 分集列表              中央画布                    Ep.1 导演台 ✕     │
│ ┌────────────┐    ┌───┐  ┌───┐  ┌───┐    ┌─────────────────────┐   │
│ │ ▶ Ep.2     │    │01 │→│02 │→│03 │    │ [剧本][分镜][卡片]  │   │
│ ├────────────┤    └───┘  └───┘  └───┘    │                     │   │
│ │ ▼ Ep.1 ◀───┼─→ 选中                    │ 分镜列表            │   │
│ │ (当前)     │                            │ • #01 俯视镜头 ✓   │   │
│ │ ├─ SCENE 01│                            │ • #02 中景 ✓       │   │
│ │ │  ├─ #01  │                            │ • #03 特写 (处理中)│   │
│ │ │  ├─ #02  │                            │                     │   │
│ │ │  └─ #03  │                            │ [生成分镜表]        │   │
│ │ └─ SCENE 02│                            └─────────────────────┘   │
│ │            │                                                      │
│ │ [智能拆分] │                                                      │
│ └────────────┘                                                      │
└─────────────────────────────────────────────────────────────────────┘
        ↓ 点击画布节点
┌─────────────────────────────────────────────────────────────────────┐
│ 📁 第一集 > 分镜                                                    │
│                                                                     │
│ 分集列表              中央画布                    镜头 #02 ✕        │
│ ┌────────────┐    ┌───┐  ┌───┐               ┌─────────────────┐   │
│ │ ▼ Ep.1     │    │01 │  │02◀┼────────────→│   [预览图]      │   │
│ │ (当前)     │    └───┘  │(选)│              │   中景          │   │
│ │ ...        │           └───┘              │   静态          │   │
│ │            │                              ├─────────────────┤   │
│ │            │                              │ 对白: [输入...] │   │
│ │            │                              │ 音效: [输入...] │   │
│ │            │                              │                 │   │
│ │            │                              │ 分辨率 [2K ▼]   │   │
│ │            │                              │ 风格 [写实 ▼]   │   │
│ │            │                              │                 │   │
│ │            │                              │ [生图][重绘]    │   │
│ └────────────┘                              └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.5.2 交互逻辑

| 触发动作 | 左侧面板 | 中央画布 | 右侧面板 | 说明 |
|---------|---------|---------|---------|------|
| **默认** | 收缩(48px) | 显示当前集 | 隐藏 | 纯净画布模式 |
| **点击左图标** | 展开(240px) | 保持 | 保持 | 显示功能列表 |
| **点击剧集** | 保持 | 切换画布 | 显示导演台 | 每集独立画布 |
| **点击节点** | 保持 | 选中高亮 | 显示节点编辑 | 替换导演台 |
| **点击空白** | 保持 | 取消选择 | 关闭 | 回到纯净模式 |
| **ESC 键** | 保持 | 取消选择 | 关闭 | 快捷键关闭 |

#### 3.5.3 功能点 (v6.0)

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **每集独立画布** | 点击左侧剧集进入对应画布 | P0 |
| **极简节点形式** | 120px × 80px 精简显示，可展开 | P0 |
| **Scene Master** | 25格分镜总览节点 (280×320) | P1 |
| **节点连线** | 拖拽创建连线，表示镜头关系 | P1 |
| **动态右侧面板** | 导演台/节点编辑/隐藏三种模式 | P0 |
| **画布状态保存** | 节点位置、缩放、连线持久化 | P1 |
| **批量生成** | 一键生成全场景分镜 | P0 |
| **双击聚焦** | 双击 Scene Master 聚焦该场景所有镜头 | P1 |

#### 3.5.4 分镜节点组件 (ShotNode)

**默认状态 (折叠)**
```
┌─────────────────────┐
│ #13         ●       │  ← 编号 + 状态色标
│ ┌───────────────┐   │
│ │    [缩略图]    │   │  ← 80×45px
│ └───────────────┘   │
│ 俯视镜头            │  ← 景别
└─────────────────────┘
尺寸: 120px × 80px
```

**展开状态**
```
┌─────────────────────────────────────┐
│ #13 俯视镜头              ●      ✕ │  ← 标题栏
│ ┌─────────────────────────────┐     │
│ │                             │     │
│ │       [预览图]               │     │  ← 160×90px
│ │                             │     │
│ └─────────────────────────────┘     │
│ 旋转(Orbit)                         │  ← 运镜方式
├─────────────────────────────────────┤
│ 对白: 林恩(画外): "来..."           │
│ 音效: 风啸声                        │
├─────────────────────────────────────┤
│ ○────────────────────────────○     │  ← 输入/输出锚点
│ [编辑详情] → 打开右侧面板            │
└─────────────────────────────────────┘
尺寸: 280px × 自适应
```

**状态色标定义**
| 状态 | 颜色 | 说明 |
|------|------|------|
| pending | 🔴 红色 | 待处理 |
| processing | 🟡 黄色 | 处理中 |
| completed | 🟢 绿色 | 已完成 |
| approved | 🔵 蓝色 | 已批准 |
| revision | 🟠 橙色 | 需修改 |

#### 3.5.5 Scene Master 节点 (25格概览)

```
┌─────────────────────────────────┐
│ SCENE 01 Master        ●     ✕ │  ← 标题 + 状态 + 关闭
│ ┌───┬───┬───┬───┬───┐          │
│ │ 1 │ 2 │ 3 │ 4 │ 5 │          │  ← 25格缩略图 (5×5)
│ ├───┼───┼───┼───┼───┤          │
│ │ 6 │ 7 │ 8 │ 9 │10 │          │
│ ├───┼───┼───┼───┼───┤          │
│ │11 │12 │13 │14 │15 │          │
│ ├───┼───┼───┼───┼───┤          │
│ │16 │17 │18 │19 │20 │          │
│ ├───┼───┼───┼───┼───┤          │
│ │21 │22 │23 │24 │25 │          │
│ └───┴───┴───┴───┴───┘          │
│ [查看详情] [展开镜头]           │  ← 操作按钮
└─────────────────────────────────┘
尺寸: 280px × 320px

交互:
- 单击: 选中，右侧面板显示场景详情
- 双击: 聚焦到该场景的所有镜头节点
- 拖拽: 移动整个 Scene Master
```

#### 3.5.6 节点连线系统

**连线类型**
| 类型 | 样式 | 用途 |
|------|------|------|
| sequence | 实线 + 箭头 | 镜头播放顺序 |
| reference | 虚线 | 引用/关联关系 |

**连线操作**
- **创建**: 拖拽节点输出锚点 → 目标节点输入锚点
- **删除**: 点击连线，确认删除
- **取消**: ESC 键取消正在创建的连线

**连线动画**
- 创建时: 连线从源节点动画延伸到目标节点
- 选中时: 连线高亮显示
- 数据流: 可配置连线上的数据流动画 (如视频生成进度)

---

### 3.6 生产模块 (待实现)

#### 3.6.1 分镜生图 (Image Generation)

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 画面风格 | 9 种预设风格（影视写实、国风3D、精致日漫等） | P1 |
| 分辨率 | 2K 高清 / 4K 超清 | P1 |
| 比例 | 16:9 / 9:16 / 1:1 / 4:3 | P0 |
| 局部重绘 | Inpaint：标记区域重新生成 | P2 |
| 智能扩图 | Outpaint：扩展画面边缘 | P2 |
| 虚拟摄像机 | 调整水平/垂直角度、焦距、光圈 | P2 |
| 角色一致性 | 上传参考图，保持角色外貌不变 | P1 |

#### 3.6.2 图转视频 (Video Generation)

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 生成引擎 | Veo 2.1 / Veo 3.1 Pro / Sora (可选) | P1 |
| 时长 | 5秒 / 10秒 | P0 |
| 关键帧 | 首帧图 + 尾帧图 (可选) | P1 |
| 动态指令 | Camera Push In, Slow Motion, Zoom Out 等 | P1 |

#### 3.6.3 资产管理 (Asset Manager)

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 角色库 | 姓名、外貌、性格、参考图 | P1 |
| 场景库 | 地点、氛围、参考图 | P1 |
| 道具库 | 关键道具的视觉 Token | P1 |
| AI 提取 | 从小说/剧本自动提取资产 | P0 |
| 多视图 | 角色：正/侧/背全身 + 面部特写 | P1 |

---

### 3.7 后期制作模块 (Roadmap)

#### 3.7.1 TTS 配音

| 功能 | 描述 |
|------|------|
| 音色选择 | 多种预设音色 |
| 台词输入 | 支持批量导入 |
| 情感控制 | 语速、语调、情绪 |
| 角色绑定 | 每个角色绑定专属音色 |

#### 3.7.2 BGM 生成

| 功能 | 描述 |
|------|------|
| 模式 | 纯音乐 / 带歌词 |
| 风格 | Cinematic, Electronic, Orchestral 等 |
| 时长 | 30秒 / 60秒 / 自定义 |
| 引擎 | Suno V3 |

#### 3.7.3 字幕生成

| 功能 | 描述 |
|------|------|
| 语音识别 | 自动从配音生成字幕 |
| 时间轴 | 自动对齐 |
| 样式 | 字体、颜色、位置 |
| 导出 | SRT / ASS / 硬烧 |

#### 3.7.4 视频合成

| 功能 | 描述 |
|------|------|
| 轨道编辑 | 视频轨 + 音频轨 + 字幕轨 |
| 转场效果 | 淡入淡出、溶解、切换 |
| 导出格式 | MP4 / MOV / 剪映草稿 |
| 分辨率 | 1080p / 2K / 4K |

---

## 4. 全局 AI 助手

### 4.1 定位

**全局 AI 助手**是贯穿所有模块的智能交互入口，用户可以通过自然语言完成任意操作。

### 4.2 核心能力

| 能力 | 描述 |
|------|------|
| 上下文感知 | 自动识别当前模块、项目、选中内容 |
| 意图识别 | 理解用户自然语言指令 |
| 智能路由 | 将指令分发到对应的专业 Agent |
| SDUI 交互 | 返回可点击按钮，降低操作门槛 |
| 多轮对话 | 支持追问和上下文记忆 |

### 4.3 交互设计 (v6.0 底部浮动栏)

#### 4.3.1 布局

**设计变更**: AI 助手从右侧边栏改为底部浮动栏，始终可见，不占用侧边栏空间。

```
┌─────────────────────────────────────────────────────────────┐
│                        中央画布                             │
│                                                             │
│              ┌───┐      ┌───┐      ┌───┐                   │
│              │01 │─────→│02 │─────→│03 │                   │
│              └───┘      └───┘      └───┘                   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 🤖 AI 助手 (底部浮动栏 - 始终可见)                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │  [对话历史...]                                          │ │
│ │                                                         │ │
│ │  AI: 需要我做什么？                                     │ │
│ │                                                         │ │
│ │  ┌────────┐ ┌────────┐ ┌────────┐                      │ │
│ │  │ 续写   │ │ 扩写   │ │ 润色   │   ← SDUI 快捷按钮    │ │
│ │  └────────┘ └────────┘ └────────┘                      │ │
│ │                                                         │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ 📍 当前上下文: 第一集:深井的回响 > 镜头 #03             │ │
│ │ [@场景 S01] [快捷指令 ▼]  输入指令...              [→] │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
位置: 固定底部，距底 24px，居中
宽度: 最大 800px，自适应
高度: 收起 56px / 展开 400px
```

**展开状态 (点击输入框或快捷按钮)**
```
┌─────────────────────────────────────────────────────────────┐
│                        中央画布                             │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 🤖 AI 助手 (展开状态)                                       │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 💬 对话历史                                             │ │
│ │ ┌───────────────────────────────────────────────────┐   │ │
│ │ │ 用户: 帮我优化这段对白                              │   │ │
│ │ │                                                   │   │ │
│ │ │ AI: 建议改为更口语化的表达：                        │   │ │
│ │ │ 原: "林恩(喘息): 呼...呼..."                        │   │ │
│ │ │ 改: "林恩: (大口喘气) 呼...该死..."                 │   │ │
│ │ │                                                   │   │ │
│ │ │ ┌────────┐ ┌────────┐                            │   │ │
│ │ │ │✓ 应用  │ │✎ 自定义│                            │   │ │
│ │ │ └────────┘ └────────┘                            │   │ │
│ │ └───────────────────────────────────────────────────┘   │ │
│ │                                                         │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ 📍 第一集:深井的回响 > 镜头 #03                         │ │
│ │ [@场景 S01] [快捷指令 ▼]  输入指令...              [→] │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**上下文感知显示**
| 当前选中 | 上下文标签 |
|---------|-----------|
| 无 | 显示项目名称 |
| 剧集 | 显示 "第一集:XXX" |
| 场景 | 显示 "场景 S01" |
| 节点 | 显示 "镜头 #03" |

**快捷指令菜单**
```
┌─────────────┐
│ 快捷指令 ▼  │
├─────────────┤
│ ✏️ 续写下文  │
│ 📝 扩写片段  │
│ ✨ 润色优化  │
│ 📊 情绪曲线  │
│ 🎭 角色弧光  │
│ 🖼️ 生成分镜  │
└─────────────┘
```

#### 4.3.2 按钮交互协议 (SDUI)

**核心原则** (保持不变):
1. ❌ 不将按钮点击转换为聊天消息
2. ✅ 直接发送 Action 到后端 `/api/action`
3. ✅ 后端返回新的 AI 回复（带新按钮）

**底部栏优势**:
- 始终可见，随时可用
- 不占用画布或侧边栏空间
- 上下文感知，自动关联当前选中对象
- 展开/收起不影响其他面板操作

#### 4.3.2 按钮交互协议 (SDUI)

**核心原则**：
1. ❌ 不将按钮点击转换为聊天消息
2. ✅ 直接发送 Action 到后端 `/api/action`
3. ✅ 后端返回新的 AI 回复（带新按钮）

---

## 5. 高级功能

### 5.1 实时导演 (Live Directing)

**功能描述**：超越简单的"暂停-修改-继续"，系统支持在 Agent 运行时直接修补状态。就像导演在片场随时拿对讲机喊话，Agent (演员) 立即调整表演，无需重置场景。

**使用场景**：
- Agent 正在写第 5 章，用户突然决定："把背景设为雨夜"
- 修改主角性格设定，立即生效到后续生成
- 调整文风或情绪基调

**实现方式**：
```
用户: "把男主性格改得更冷酷"
        │
        ▼
┌─────────────────────────────────────────┐
│ 🎬 实时导演控制台                       │
│                                         │
│ 当前状态: 正在生成 Chapter 5...         │
│                                         │
│ 快速调整:                               │
│ ● 性格: 温和善良 → ○ 冷酷果断           │
│                                         │
│ [软重启] [立即生效]                     │
└─────────────────────────────────────────┘
        │
        ▼
PATCH /api/state
{
  "thread_id": "thread_001",
  "patches": {
    "character_bible.hero_personality": "冷酷果断"
  }
}
        │
        ▼
下一个生成的段落立即体现新性格
```

**两种模式**：

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **软重启** | 保留已生成内容，从下一节点应用修改 | 轻微调整 |
| **硬重启** | 中断当前生成，从指定节点重新开始 | 重大修改 |

### 5.2 时间旅行与平行宇宙 (Time Travel & Branching)

**功能描述**：用户可以基于任意历史节点创建新的剧情分支，保留原版本的同时探索不同走向。利用 LangGraph 的 Checkpoint 机制，实现"平行宇宙"功能。

**使用场景**：
- 用户想基于第 3 章创建"复仇版"剧情分支，同时保留原"虐恋版"
- 对比不同故事走向的效果
- A/B 测试不同剧情设定

**操作流程**：
```
主线剧情
├─ Chapter 1
├─ Chapter 2
├─ Chapter 3 (分叉点)
│   ├─ Chapter 4 (虐恋版) [当前]
│   ├─ Chapter 5
│   └─ Chapter 6
│
└─ [+ 创建分支]
    │
    ▼
平行宇宙 A: 复仇版
├─ Chapter 3 (继承原设定)
├─ Chapter 4 (复仇走向)
└─ Chapter 5

平行宇宙 B: 甜宠版
├─ Chapter 3 (继承原设定)
└─ Chapter 4 (甜宠走向)
```

**界面展示**：
```
┌─────────────────────────────────────────┐
│ 分支管理 - 《野犬加冕》                  │
├─────────────────────────────────────────┤
│                                         │
│ 📍 主线 (当前)                          │
│ ●───●───●───●───────►                  │
│ 1   2   3   4                          │
│                                         │
│ 🌿 分支 (2)                             │
│ ├─ 复仇版 (运行中)                      │
│ │  ●───●───●───●                       │
│ │  1   2   3   4'                      │
│ │                                      │
│ └─ 甜宠版 (暂停)                        │
│    ●───●───●                           │
│    1   2   3''                         │
│                                         │
│ [+ 从 Chapter 3 创建分支]              │
│ [🔄 切换分支] [🗑️ 删除分支]             │
│                                         │
└─────────────────────────────────────────┘
```

### 5.3 并发生成 (Map-Reduce)

**功能描述**：当需要批量生成内容时（如 20 个场景的分镜），系统使用 Map-Reduce 模式并行处理，大幅缩短总耗时。

**工作原理**：
```
剧本: 20 个场景
        │
        ▼
┌─────────────────────────────────────────┐
│ Map: 分发并行任务                       │
│ ├─ Task 1: Scene 1 分镜生成            │
│ ├─ Task 2: Scene 2 分镜生成            │
│ ├─ Task 3: Scene 3 分镜生成            │
│ ...                                    │
│ └─ Task 20: Scene 20 分镜生成          │
│                                         │
│ (最大并发数: 5，避免 API 限流)          │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│ Reduce: 结果汇聚                        │
│ ├─ 收集所有场景的分镜                    │
│ ├─ 按场景顺序排序                        │
│ ├─ 生成连续镜头编号                      │
│ └─ 统一输出格式                          │
└─────────────────────────────────────────┘
        │
        ▼
完整分镜列表 (20 场景 × 平均 3 分镜 = 60 个镜头)
总耗时: 约 12 分钟 (串行约 60 分钟)
```

**前端展示**：
```
┌─────────────────────────────────────────┐
│ 批量生成分镜 (20 场景)                  │
├─────────────────────────────────────────┤
│                                         │
│ 并发设置: [5] 个并行 (推荐)             │
│                                         │
│ 进度: ████████████░░░░ 80%              │
│                                         │
│ 场景 1:  ✅ 完成 (3 分镜)               │
│ 场景 2:  ✅ 完成 (4 分镜)               │
│ 场景 3:  🔄 生成中...                   │
│ 场景 4:  ⏳ 等待中                      │
│ ...                                     │
│ 场景 20: ⏳ 等待中                      │
│                                         │
│ 预计剩余时间: 2 分钟                    │
│                                         │
│ [暂停] [取消]                           │
└─────────────────────────────────────────┘
```

---

## 6. 非功能需求

### 5.1 性能需求

| 指标 | 要求 | 优先级 |
|------|------|--------|
| 页面加载 | < 3 秒 | P0 |
| AI 首次响应 | < 2 秒 (流式) | P0 |
| 画布流畅度 | 60fps，支持 100+ 卡片 | P1 |
| 图片生成 | < 30 秒 | P1 |
| 视频生成 | < 120 秒 (5秒视频) | P1 |

### 5.2 兼容性

| 项目 | 要求 |
|------|------|
| 浏览器 | Chrome, Edge, Safari, Firefox (最新2版本) |
| 分辨率 | 1920×1080 及以上 |
| 设备 | 主要桌面端，移动端仅基础浏览 |

### 5.3 安全性

- 用户数据加密存储 (AES-256)
- API 访问权限控制 (JWT + RBAC)
- 内容审核机制 (敏感词过滤)

---

## 6. 技术架构

### 6.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Frontend (Vite + React 19)                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │
│  │  React Router  │  │  Zustand Store │  │  SDUI Renderer │                 │
│  │  (Navigation)  │  │  (State Mgmt)  │  │  (Action Block)│                 │
│  └────────────────┘  └────────────────┘  └────────────────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                              API Gateway (FastAPI)                           │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │
│  │  REST API      │  │  SSE Stream    │  │  Action API    │                 │
│  │  /api/*        │  │  /api/stream   │  │  /api/action   │                 │
│  └────────────────┘  └────────────────┘  └────────────────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                              Agent Orchestration (LangGraph)                 │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐               │
│  │  Market    │ │  Story     │ │  Module A  │ │  Module B  │               │
│  │  Analyst   │ │  Planner   │ │  (Novel)   │ │  (Script)  │               │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘               │
├─────────────────────────────────────────────────────────────────────────────┤
│                              Data Layer                                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │
│  │  PostgreSQL    │  │  Redis         │  │  Supabase      │                 │
│  │  (Supabase)    │  │  (Cache/Queue) │  │  Storage       │                 │
│  └────────────────┘  └────────────────┘  └────────────────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **Frontend** | Vite + React 19 | SPA 架构 |
| **UI Framework** | Shadcn/UI + TailwindCSS | 暗色优先设计 |
| **State Management** | Zustand | 多 Store 架构 |
| **Backend** | Python FastAPI | 高性能异步 |
| **Agent** | LangGraph | 有状态多 Agent |
| **Database** | PostgreSQL (Supabase) | 主数据 + pgvector |
| **Cache** | Redis | 会话、队列、PubSub |
| **Storage** | Supabase Storage | 对象存储 |
| **Queue** | Celery + Redis | 异步任务 |

### 6.3 AI 能力配置

| 能力名称 | 用途说明 | 优先级 |
|---------|---------|--------|
| Gemini Intelligence | 文本生成、智能推理、提示词生成 | P0 |
| Generate Images | 分镜图像、角色参考图 | P0 |
| Analyze Images | 参考图风格特征提取 | P1 |
| AI Powered Chatbot | 多轮对话、自然语言修改 | P0 |
| Content Generation | 小说/剧本/分镜批量生成 | P0 |
| Global Model Management | BYOK + 任务-模型路由 | P0 |
| Database Connection | 项目数据持久化 | P0 |
| File System Access | 文件导入导出 | P1 |

---

## 7. AI 系统提示词架构

### 7.1 Prompt as Code 结构

```
prompts/
├── 0_Master_Router.md           # Master Router (意图识别 + 路由)
├── 1_Market_Analyst.md          # Market Analyst (市场分析)
├── 2_Story_Planner.md           # Story Planner (方案生成)
├── 3_Skeleton_Builder.md        # Skeleton Builder (人设大纲)
├── 4_Novel_Writer.md            # Novel Writer (小说撰写)
├── 5_Script_Adapter.md          # Script Adapter (剧本改编)
├── 6_Storyboard_Director.md     # Storyboard Director (分镜设计)
├── 7_Editor_Reviewer.md         # Editor Reviewer (质量审阅)
├── 8_Refiner.md                 # Refiner Agent (内容精修)
├── 9_Analysis_Lab.md            # Analysis Lab (情绪分析)
└── 10_Asset_Inspector.md        # Asset Inspector (资产检查)
```

### 7.2 每个 Prompt 的规范结构

```markdown
# System Prompt: [Agent Name] ([Level/Module])

## Role Definition (角色定义)
[Agent 的核心职责和身份定义]

## Input Context (输入上下文)
[列出所有可用的输入变量，使用 {variable} 格式]

## Core Principles / Tasks (核心原则/任务)
[Agent 必须遵守的规则和执行的任务]

## Output Format (输出格式)
[期望的输出结构，通常包含 JSON 示例]

## UI_Interaction_Block (前端交互数据)
[必须输出的 JSON 块，用于驱动前端 UI]
- block_type: action_group / selector / confirmation / etc.
- title: 交互块标题
- description: 描述文字
- buttons: 按钮数组

## Quality Control Features (质量控制)
- Anti-Cliché Radar: 检测并拒绝陈旧的创意组合
- Consistency Lock: 确保输出符合上游设定
- Quality Gate: 依据 Skill Matrix 进行多维度评分
```

### 7.3 Variable Naming Convention

| 变量类型 | 命名规范 | 示例 |
|---------|---------|------|
| 用户配置 | `user_config.*` | `{user_config.total_episodes}` |
| 上游产物 | `{artifact_name}` | `{character_bible}`, `{market_report}` |
| 系统状态 | `{state_name}` | `{history_summary}`, `{hero_state}` |

---

## 8. 数据模型

### 8.1 核心实体

```sql
-- 项目表
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    genre VARCHAR(100),
    status VARCHAR(50) DEFAULT 'draft',
    config JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 通用内容节点表 (支持无限画布)
CREATE TABLE story_nodes (
    node_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES story_nodes(node_id) ON DELETE SET NULL,
    type VARCHAR(50) NOT NULL,  -- episode, scene, shot, character, outline
    content JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 节点布局表
CREATE TABLE node_layouts (
    node_id UUID REFERENCES story_nodes(node_id) ON DELETE CASCADE,
    canvas_tab VARCHAR(50),
    position_x FLOAT DEFAULT 0,
    position_y FLOAT DEFAULT 0,
    PRIMARY KEY (node_id, canvas_tab)
);
```

### 8.2 JSONB 结构

```typescript
// user_config
{
  "genre": "复仇逆袭",
  "sub_tags": ["重生", "打脸", "大女主"],
  "tone": ["爽感", "暗黑"],
  "word_count_per_episode": 500,
  "total_episodes": 10,
  "ending_type": "HE",
  "style_dna": {
    "sentence_length": "short",
    "rhetoric": ["暗喻", "排比"],
    "vocabulary": "modern"
  }
}

// market_report
{
  "compatibility_score": 85,
  "trend_index": "High",
  "swot": {
    "strengths": "题材自带流量...",
    "weaknesses": "市场同质化严重...",
    "opportunities": "结合 AI 元素...",
    "threats": "监管收紧..."
  },
  "competitor_reference": [
    {"title": "《厉总的哑巴新娘》", "type": "典型竞品"}
  ]
}
```

---

## 9. 术语表

| 术语 | 说明 |
|------|------|
| Agent | 具有特定职责的 AI 智能体 |
| SDUI | Server-Driven UI，服务端驱动界面 |
| Action | 前端按钮触发的后端操作 |
| Agentic Workflow | 多 Agent 协作的工作流 |
| Nano Banana Prompt | 用于 AI 生图的标准化英文提示词 |
| Scene Master | 25 格分镜总览卡片 |
| Inpaint | 局部重绘 |
| Outpaint | 智能扩图 |
| Skill Matrix | 多维度质量评分矩阵 |

---

## 10. 版本记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| V3.0 | 2026-02-02 | 融合 V1 + V2，形成可实施版本 |
| V2.0 | 2026-02-02 | 全新架构设计，增加全局 AI 助手 |
| V1.x | 历史 | 见 Product-Spec.md |

---

**文档结束**

*本文档融合 V1 的详细功能规格和 V2 的现代化产品定位，可直接用于开发实施。详见配套文档：System-Architecture-V3.md, Frontend-Design-V3.md, Implementation-Roadmap.md*
